extends layouts/layout
block loadtitle
    -var title='CMS 荣誉详情'

append styles
    link(rel='stylesheet', href='/plugins/jquery-file-upload/css/jquery.fileupload.css')
    link(rel='stylesheet', href='/styles/loading.css')

block cms_content
    .content_main
        mixin toastr(status, msg)
        .container-fluid
            section.todo-content
                div.panel-title.pll 荣誉详情
                    small 荣誉详情维护
            .col-md-12: .box.box-info
                .box-header.with-border: h3.box-title 荣誉详情维护
                form.form-horizontal(data-validate="parsley", method='post', action='/cms/honor/update')
                    .box-body
                        .col-sm-8
                            .form-group
                                input#id(name='id',type='hidden',value="#{honor.id}")
                                label.col-sm-2.control-label(for='honor_name') 证书名称
                                .col-sm-10: input#honor_name.form-control.parsley-validated(name='honor_name',type='text',placeholder='证书名称',
                                value="#{honor.honor_name}",autocomplete="off",data-required="true")
                            .form-group
                                label.col-sm-2.control-label(for='certification') 发证机构
                                .col-sm-4: input#certification.form-control.parsley-validated(name='certification',type='text',placeholder='发证机构',
                                value="#{honor.certification}",autocomplete="off")
                                label.col-sm-2.control-label(for='publish_date') 发证日期
                                .col-sm-4: input#publish_date.form-control.parsley-validated(name='publish_date',type='text',placeholder='发证日期',
                                value="#{honor.publish_date}",data-type="dateIso")
                            .form-group
                                label.col-sm-2.control-label(for='expiry_date') 有效期
                                .col-sm-4: input#expiry_date.form-control.parsley-validated(name='expiry_date',type='text',placeholder='不填则长期有效',
                                value="#{honor.expiry_date}",data-type="dateIso")
                                label.col-sm-2.control-label(for='createtime') 创建日期
                                .col-sm-4: input#createtime.form-control.parsley-validated(name='createtime',type='text',placeholder='创建日期',
                                value="#{honor.createtime}",data-type="dateIso")
                            .form-group
                                label.col-sm-2.control-label 上传图片
                                .col-sm-10: span.btn.btn-default.fileinput-button
                                    i.fa.fa-picture-o
                                    span 选择图片
                                    input#file1(type='file',name='files[]')
                                    //,multiple='multiple',accept='image/gif,image/jpeg,image/jpg,image/png,image/svg')
                            .form-group: .col-sm-offset-2.col-sm-10
                                blockquote.note.note-info
                                    h4 注意事项
                                    ul
                                        //li 支持多选
                                        li 最大文件大小上传
                                            strong 200MB
                                            | .
                                        li 支持的图片类型有（
                                            strong JPG, GIF, PNG
                                            | ）.
                            .form-group: .col-sm-offset-2.col-sm-10
                                a.btn.btn-default(type='button',href='/cms/honor') 取消更改
                                input#btn_submit.btn.btn-info.mll(name='btn_submit',type='button',value='确认更改')
                        .col-sm-4
                            .form-group: .col-sm-12: img(src='#{honor.pic_url_loc?honor.pic_url_loc:""}',width='80%',style='margin:auto;')

append cms_content
    #loading.spinner-div: .spinner
        .spinner-container.container1
            .circle1
            .circle2
            .circle3
            .circle4
        .spinner-container.container2
            .circle1
            .circle2
            .circle3
            .circle4
        .spinner-container.container3
            .circle1
            .circle2
            .circle3
            .circle4

append scripts
    script(type='text/javascript',src='/plugins/jquery-file-upload/js/jquery.fileupload-ajax.js')
    script(type='text/javascript').
        $("#btn_submit").on('click', function () {
            //表单验证
            var valid = $("form").parsley().validate();
            if (!valid)
                return;

            //表单验证通过：则提交
            $.ajax({
                url: "/cms/honor/update",
                type: "post",
                dataType: "json",
                data: $("form").serialize(),
                success: function (data) {
                    if (data.status > 0) {
                        toastrShow(data.status, data.msg);
                        setTimeout(function () {
                            window.location = "/cms/honor";
                        }, '1500')
                    }else{
                        toastrShow(data.status, data.msg);
                    }
                }
            });
        });

        $(document).ready(function () {
            $("#publish_date").datepicker({todayHighlight: true, format: 'yyyy-mm-dd', autoclose: true});
            $("#expiry_date").datepicker({todayHighlight: true, format: 'yyyy-mm-dd', autoclose: true});
            $("#createtime").datepicker({todayHighlight: true, format: 'yyyy-mm-dd', autoclose: true});
        });
    script(type='text/javascript').
        //当选中文件,则立即执行上传
        $(document).on("change", "#file1", function () {
            if ($("#file1").val() != "") {
                FileAction.FileUpload("file1", 2);
            }
        });

        //取得整个html高度
        var height = $(document).height();
        var isIE = /msie/i.test(navigator.userAgent) && !window.opera;
        ///异步ajax上传
        var FileAction = {
            FileUpload: function (fileid, AttachType) {
                if (!fileChange(fileid)) {
                    return;
                }
                // 开始上传文件时显示一个图片
                $(document).ajaxStart(function () {
                    $("#loading").height(height);
                    $("#loading").show();
                    // 文件上传完成将图片隐藏起来
                }).ajaxComplete(function () {
                    $("#loading").hide();
                });
                $.ajaxFileUpload({
                    url: '/cms/picture/fileupload',
                    secureuri: false,
                    fileElementId: fileid,
                    dataType: 'json',
                    success: function (data) {
                        if (data.status > 0) {
                            toastrShow(1, "上传成功!")

                        }else{
                            toastrShow(2, "上传失败!")
                        }
                    },
                    error: function (err) {
                        //fails
                        //toastrShow(data.state, data.msg)
                        console.log(err);
                    }
                });
            }
        };

        function fileChange(target) {
            var fileSize = 0;
            var filetypes = [".jpg", ".gif", ".png", ".txt", ".rar", ".zip", ".doc", ".xls",
                ".ppt", ".pdf", ".docx", ".xlsx", ".mp4", ".avi", ".wmv"];
            var filepath = $("#" + target).val();
            var filemaxsize = 1024 * 200;//2M
            if (filepath) {
                var isnext = false;
                var fileend = filepath.substring(filepath.lastIndexOf("."));
                if (filetypes && filetypes.length > 0) {
                    for (var i = 0; i < filetypes.length; i++) {
                        if (filetypes[i] == fileend) {
                            isnext = true;
                            break;
                        }
                    }
                }
                if (!isnext) {
                    toastrShow(2, "不接受此文件类型！");
                    $("#" + target).val("");
                    return false;
                }
            } else {
                return false;
            }
            if (isIE && !$("#" + target).prop('files')) {
                try {
                    var filePath = $("#" + target).val();
                    var fileSystem = new ActiveXObject("Scripting.FileSystemObject");
                    if (!fileSystem.FileExists(filePath)) {
                        toastrShow(2, "附件不存在，请重新上传！");
                        return false;
                    }
                    var file = fileSystem.GetFile(filePath);
                    fileSize = file.Size;
                } catch (e) {
                    toastrShow(2, "由于浏览器安全问题，请按照以下设置：<br/> [1] 打开Internet Explorer 工具-->选项-->安全-->可信站点-->自定义级别，<br/> [2] 找到“对未标记为可安全执行脚本的 Activex 控件初始化并执行脚本”设置成“启用”<br/> [3] 刷新页面，重新上传（如果还是无法上传，尝试关闭浏览器重新打开再上传）")
                    return false;
                }
                return true;
            } else {
                fileSize = $("#" + target).prop('files')[0].size;
            }

            var size = fileSize / 1024;
            if (size > filemaxsize) {
                toastrShow(2, "附件大小不能大于" + filemaxsize / 1024 + "M！");
                $("#" + target).val("");
                return false;
            }
            if (size <= 0) {
                toastrShow(2, "附件大小不能为0M！");
                $("#" + target).val("");
                return false;
            }
            return true;
        }
